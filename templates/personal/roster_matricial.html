{% extends 'base.html' %}

{% block title %}Roster Matricial - {{ mes_nombre }} {{ anio }}{% endblock %}

{% block extra_css %}
<style>
    .roster-table {
        font-size: 0.85rem;
    }
    .roster-table th {
        background-color: #2c3e50;
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
        white-space: nowrap;
        padding: 8px 4px;
        text-align: center;
        border: 1px solid #1a252f;
    }
    .roster-table td {
        padding: 6px 4px;
        text-align: center;
        border: 1px solid #dee2e6;
    }
    .col-nombre {
        position: sticky;
        left: 0;
        background-color: white;
        z-index: 5;
        text-align: left;
        min-width: 200px;
        font-weight: 500;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    .roster-table thead th.col-nombre {
        z-index: 15;
        background-color: #1a252f;
    }
    .col-dias-libres {
        background-color: #e7f3ff;
        font-weight: bold;
    }
    .col-dias-trabajados {
        background-color: #fff3cd;
        font-weight: bold;
    }
    .codigo-dia {
        min-width: 35px;
        font-weight: 500;
    }
    .codigo-numerico {
        background-color: #d4edda;
    }
    .codigo-letra {
        background-color: #f8f9fa;
    }
    .codigo-vacio {
        background-color: #fff;
    }
    .codigo-input {
        width: 100%;
        border: 1px solid #dee2e6;
        padding: 4px;
        text-align: center;
        font-weight: 500;
        text-transform: uppercase;
    }
    .codigo-input:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .codigo-input:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
        opacity: 0.6;
    }
    .saving {
        background-color: #fff3cd !important;
    }
    .saved {
        background-color: #d1e7dd !important;
    }
    .error {
        background-color: #f8d7da !important;
    }
    .table-container {
        overflow-x: auto;
        max-width: 100%;
        position: relative;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
    }
    .table-container::-webkit-scrollbar {
        height: 12px;
    }
    .table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    .table-container::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 10px;
    }
    .table-container::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    .header-dia {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        min-height: 60px;
        padding: 4px 2px;
    }
    @media print {
        .no-print {
            display: none;
        }
        .roster-table {
            font-size: 0.7rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="no-print">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-calendar-check"></i> Roster Matricial - {{ mes_nombre }} {{ anio }}</h2>
        <div>
            <a href="{% url 'roster_import' %}" class="btn btn-success me-2">
                <i class="fas fa-file-upload"></i> Importar
            </a>
            <a href="{% url 'roster_export' %}?mes={{ mes }}&anio={{ anio }}" class="btn btn-success me-2">
                <i class="fas fa-file-excel"></i> Exportar
            </a>
            <button onclick="window.print()" class="btn btn-secondary me-2">
                <i class="fas fa-print"></i> Imprimir
            </button>
            <a href="{% url 'roster_list' %}" class="btn btn-info">
                <i class="fas fa-list"></i> Vista Lista
            </a>
        </div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">Mes:</label>
                    <select name="mes" class="form-select">
                        {% for m_num, m_nombre in meses %}
                            <option value="{{ m_num }}" {% if m_num == mes %}selected{% endif %}>{{ m_nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Año:</label>
                    <select name="anio" class="form-select">
                        {% for a in anios %}
                            <option value="{{ a }}" {% if a == anio %}selected{% endif %}>{{ a }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Área:</label>
                    <select name="area" class="form-select">
                        <option value="">Todas las áreas</option>
                        {% for a in areas %}
                            <option value="{{ a.id }}" {% if area_id == a.id|stringformat:"s" %}selected{% endif %}>
                                {{ a.gerencia.nombre }} - {{ a.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Buscar:</label>
                    <input type="text" name="buscar" class="form-control" placeholder="DNI o nombre..." value="{{ buscar }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Control de resultados por página -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <label class="form-label mb-0">
                        <i class="fas fa-list"></i> Resultados por página:
                    </label>
                </div>
                <div class="col-md-6">
                    <div class="btn-group w-100" role="group">
                        <a href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page=10" 
                           class="btn btn-sm {% if per_page == '10' %}btn-primary{% else %}btn-outline-primary{% endif %}">10</a>
                        <a href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page=20" 
                           class="btn btn-sm {% if per_page == '20' %}btn-primary{% else %}btn-outline-primary{% endif %}">20</a>
                        <a href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page=50" 
                           class="btn btn-sm {% if per_page == '50' %}btn-primary{% else %}btn-outline-primary{% endif %}">50</a>
                        <a href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page=100" 
                           class="btn btn-sm {% if per_page == '100' %}btn-primary{% else %}btn-outline-primary{% endif %}">100</a>
                        <a href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page=todos" 
                           class="btn btn-sm {% if per_page == 'todos' %}btn-primary{% else %}btn-outline-primary{% endif %}">Todos</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="alert alert-warning border-warning m-3 no-print" style="border-width: 3px; box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);">
            <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> LEYENDA DE CÓDIGOS - LEER ANTES DE INGRESAR</h5>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    • <strong>T</strong>: Trabajo Presencial<br>
                    • <strong>DL</strong>: Día Libre<br>
                    • <strong>DLA</strong>: Día Libre Acumulado (descuenta de días al 31/12/25, máx. 7 consecutivos)<br>
                    • <strong>DOL</strong>: Compensación por Horario Extendido<br>
                    • <strong>DM</strong>: Descanso Médico
                </div>
                <div class="col-md-6">
                    • <strong>V</strong>: Vacaciones Aprobadas y/o Gozadas<br>
                    • <strong>F</strong>: Feriado No Recuperable<br>
                    • <strong>FC</strong>: Feriado Compensable<br>
                    • <strong>Editable:</strong> Selecciona el código de la lista desplegable. Se guarda automáticamente.<br>
                    • <strong>Cálculo:</strong> Días Libres Pendientes = (Días al 31/12/25 + Ganados) - DL/DLA usados<br>
                    • <strong>Importante:</strong> DLA solo puede usarse si hay saldo disponible al 31/12/25
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-bordered table-sm roster-table mb-0">
                <thead>
                    <tr>
                        <th class="col-nombre">Personal</th>
                        <th class="col-dias-libres" title="Días disponibles al 31/12/25 menos los DLA utilizados">Saldo Días<br>al 31/12/25</th>
                        <th class="col-dias-trabajados">Días Libres<br>Ganados</th>
                        <th class="col-dias-libres">Días Libres<br>Pendientes</th>
                        {% for fecha in fechas_mes %}
                            <th class="codigo-dia">
                                <div class="header-dia">{{ fecha|date:"d" }}</div>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for fila in tabla_datos %}
                    <tr>
                        <td class="col-nombre">
                            <strong>{{ fila.personal.apellidos_nombres }}</strong><br>
                            <small class="text-muted">{{ fila.personal.nro_doc }} - {{ fila.personal.area.nombre|default:"-" }}</small>
                        </td>
                        <td class="col-dias-libres dias-libres-{{ fila.personal.id }}" title="Saldo después de descontar {{ fila.count_dla }} DLA">{{ fila.dias_libres_corte_2025 }}</td>
                        <td class="col-dias-trabajados dias-ganados-{{ fila.personal.id }}" title="T: {{ fila.count_t }}, TR: {{ fila.count_tr }}, DL usados: {{ fila.count_dl }}, DLA usados: {{ fila.count_dla }}">{{ fila.dias_libres_ganados }}</td>
                        <td class="col-dias-libres dias-pendientes-{{ fila.personal.id }}">{{ fila.dias_libres_pendientes|floatformat:0 }}</td>
                        {% for item in fila.codigos %}
                            <td class="codigo-dia 
                                {% if item.codigo == 'T' or item.codigo == 'TR' %}
                                    codigo-numerico
                                {% elif item.codigo %}
                                    codigo-letra
                                {% else %}
                                    codigo-vacio
                                {% endif %}
                            ">
                                <select 
                                    class="codigo-input" 
                                    data-personal-id="{{ fila.personal.id }}"
                                    data-fecha="{{ item.fecha|date:'Y-m-d' }}"
                                    data-fecha-alta="{{ fila.personal.fecha_alta|date:'Y-m-d'|default:'' }}"
                                    data-dias-corte="{{ fila.dias_libres_corte_2025 }}"
                                    {% if fila.personal.fecha_alta and item.fecha < fila.personal.fecha_alta %}disabled title="Anterior a fecha de alta ({{ fila.personal.fecha_alta|date:'d/m/Y' }})"{% endif %}
                                >
                                    <option value="">-</option>
                                    <option value="T" {% if item.codigo == 'T' %}selected{% endif %}>T</option>
                                    <option value="TR" {% if item.codigo == 'TR' %}selected{% endif %}>TR</option>
                                    <option value="DL" {% if item.codigo == 'DL' %}selected{% endif %}>DL</option>
                                    <option value="DLA" {% if item.codigo == 'DLA' %}selected{% endif %}>DLA</option>
                                    <option value="DOL" {% if item.codigo == 'DOL' %}selected{% endif %}>DOL</option>
                                    <option value="DM" {% if item.codigo == 'DM' %}selected{% endif %}>DM</option>
                                    <option value="V" {% if item.codigo == 'V' %}selected{% endif %}>V</option>
                                    <option value="F" {% if item.codigo == 'F' %}selected{% endif %}>F</option>
                                    <option value="FC" {% if item.codigo == 'FC' %}selected{% endif %}>FC</option>
                                </select>
                            </td>
                        {% endfor %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{{ fechas_mes|length|add:3 }}" class="text-center text-muted py-4">
                            No hay personal activo para mostrar
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Paginación -->
        {% if paginator %}
        <div class="card-footer">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="mb-0 text-muted">
                        Mostrando 
                        {% if page_obj.has_other_pages %}
                            {{ page_obj.start_index }} - {{ page_obj.end_index }}
                        {% else %}
                            {% if page_obj|length > 0 %}{{ page_obj|length }}{% else %}0{% endif %}
                        {% endif %}
                        de {{ paginator.count }} trabajadores
                    </p>
                </div>
                <div class="col-md-6">
                    <nav aria-label="Paginación">
                        <ul class="pagination pagination-sm justify-content-end mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page={{ per_page }}&page=1">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page={{ per_page }}&page={{ page_obj.previous_page_number }}">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-left"></i></span>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">
                                    Página {{ page_obj.number }} de {{ paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page={{ per_page }}&page={{ page_obj.next_page_number }}">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page={{ per_page }}&page={{ paginator.num_pages }}">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-right"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="mt-3 no-print">
    <a href="{% url 'home' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Volver al Inicio
    </a>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('.codigo-input');
    
    // Obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    // Función para actualizar el color de fondo basado en el código
    function updateCellColor(select) {
        const td = select.parentElement;
        const valor = select.value.trim().toUpperCase();
        
        td.classList.remove('codigo-numerico', 'codigo-letra', 'codigo-vacio');
        
        if (valor === '') {
            td.classList.add('codigo-vacio');
        } else if (valor === 'T' || valor === 'TR') {
            td.classList.add('codigo-numerico');
        } else {
            td.classList.add('codigo-letra');
        }
    }
    
    // Función para guardar el cambio
    function guardarCodigo(select) {
        const personalId = select.dataset.personalId;
        const fecha = select.dataset.fecha;
        const codigo = select.value.trim().toUpperCase();
        const td = select.parentElement;
        
        // Mostrar estado de guardado
        td.classList.add('saving');
        
        // Enviar al servidor
        fetch('{% url "roster_update_cell" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                personal_id: personalId,
                fecha: fecha,
                codigo: codigo
            })
        })
        .then(response => response.json())
        .then(data => {
            td.classList.remove('saving');
            if (data.success) {
                td.classList.add('saved');
                updateCellColor(select);
                
                // Actualizar días libres ganados si viene en la respuesta
                if (data.dias_libres_ganados !== undefined) {
                    const cellDiasGanados = document.querySelector(`.dias-ganados-${personalId}`);
                    if (cellDiasGanados) {
                        cellDiasGanados.textContent = data.dias_libres_ganados;
                    }
                }
                
                // Actualizar días libres pendientes si viene en la respuesta
                if (data.dias_libres_pendientes !== undefined) {
                    const cellDiasPendientes = document.querySelector(`.dias-pendientes-${personalId}`);
                    if (cellDiasPendientes) {
                        cellDiasPendientes.textContent = data.dias_libres_pendientes;
                    }
                }
                
                // Actualizar días al 31/12/25 si viene en la respuesta
                if (data.dias_libres_corte_2025 !== undefined) {
                    const cellDiasCorte = document.querySelector(`.dias-libres-${personalId}`);
                    if (cellDiasCorte) {
                        cellDiasCorte.textContent = data.dias_libres_corte_2025;
                    }
                    // Actualizar el data attribute para futuras validaciones
                    select.dataset.diasCorte = data.dias_libres_corte_2025;
                }
                
                setTimeout(() => {
                    td.classList.remove('saved');
                }, 1000);
            } else {
                td.classList.add('error');
                alert('Error: ' + data.error);
                // Revertir al valor anterior si hubo error
                if (data.revert) {
                    select.value = data.old_value || '';
                    updateCellColor(select);
                }
                setTimeout(() => {
                    td.classList.remove('error');
                }, 2000);
            }
        })
        .catch(error => {
            td.classList.remove('saving');
            td.classList.add('error');
            console.error('Error:', error);
            alert('Error al guardar el código');
            setTimeout(() => {
                td.classList.remove('error');
            }, 2000);
        });
    }
    
    // Event listeners para todos los selects
    selects.forEach(select => {
        // Inicializar color
        updateCellColor(select);
        
        // Al cambiar el valor
        select.addEventListener('change', function() {
            guardarCodigo(this);
        });
    });
});
</script>
{% endblock %}
