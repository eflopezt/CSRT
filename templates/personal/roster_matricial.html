{% extends 'base.html' %}

{% block title %}Roster Matricial - {{ mes_nombre }} {{ anio }}{% endblock %}

{% block extra_css %}
<style>
    /* Indicador de mes - NO sticky para evitar conflictos */
    .mes-indicator {
        position: relative;
        z-index: 10;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 20px;
        font-size: 1.1rem;
        font-weight: 600;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        text-align: center;
        border-radius: 0.25rem;
        margin-bottom: 10px;
    }
    
    .roster-table {
        font-size: 0.85rem;
    }
    
    /* Cabecera sticky mejorada */
    .roster-table thead {
        position: sticky;
        top: 0;
        z-index: 20;
    }
    
    .roster-table th {
        background-color: #2c3e50;
        color: white;
        white-space: nowrap;
        padding: 8px 4px;
        text-align: center;
        border: 1px solid #1a252f;
    }
    
    .roster-table td {
        padding: 6px 4px;
        text-align: center;
        border: 1px solid #dee2e6;
        transition: all 0.2s ease;
    }
    
    /* Hover effect en filas */
    .roster-table tbody tr:hover {
        background-color: #f8f9fa;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transform: scale(1.001);
    }
    
    .col-nombre {
        position: sticky;
        left: 0;
        background-color: white;
        z-index: 5;
        text-align: left;
        min-width: 200px;
        font-weight: 500;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }
    
    .roster-table thead th.col-nombre {
        z-index: 25;
        background-color: #1a252f;
    }
    
    .roster-table tbody tr:hover .col-nombre {
        background-color: #f8f9fa;
    }
    
    .col-dias-libres {
        background-color: #e7f3ff;
        font-weight: bold;
        position: sticky;
        left: 200px;
        z-index: 4;
    }
    
    .col-dias-trabajados {
        background-color: #fff3cd;
        font-weight: bold;
    }
    
    .codigo-dia {
        min-width: 50px;
        max-width: 60px;
        font-weight: 500;
        padding: 2px !important;
    }
    
    /* Colores diferenciados por código */
    .codigo-T { background-color: #d4edda !important; } /* Verde claro - Trabajo */
    .codigo-TR { background-color: #d1ecf1 !important; } /* Azul claro - Remoto */
    .codigo-DL { background-color: #cfe2ff !important; } /* Azul - Día Libre */
    .codigo-DLA { background-color: #fff3cd !important; } /* Amarillo - DL Acumulado */
    .codigo-DOL { background-color: #e2e3e5 !important; } /* Gris - Compensación */
    .codigo-DM { background-color: #f8d7da !important; } /* Rojo claro - Descanso Médico */
    .codigo-V { background-color: #e7d5ff !important; } /* Morado claro - Vacaciones */
    .codigo-F { background-color: #ffc107 !important; color: #000; } /* Amarillo fuerte - Feriado */
    .codigo-FC { background-color: #ffecb5 !important; } /* Amarillo pálido - Feriado Comp */
    
    /* Estados de aprobación */
    .estado-borrador {
        border: 3px solid #ffc107 !important;
        box-shadow: 0 0 8px rgba(255, 193, 7, 0.5) !important;
    }
    .estado-pendiente {
        border: 3px solid #fd7e14 !important;
        box-shadow: 0 0 8px rgba(253, 126, 20, 0.5) !important;
    }
    .estado-aprobado {
        /* Sin borde especial, es el estado normal */
    }
    
    /* Alerta de borradores flotante */
    #borradores-alert {
        position: fixed;
        top: 80px;
        right: 20px;
        z-index: 1000;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        animation: slideInRight 0.3s ease;
    }
    
    @keyframes slideInRight {
        from { transform: translateX(400px); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    /* Resaltar fines de semana */
    .dia-sabado { background-color: #f0f0f0 !important; }
    .dia-domingo { background-color: #e8e8e8 !important; }
    
    /* Día actual */
    .dia-actual {
        box-shadow: inset 0 0 0 2px #0d6efd;
        position: relative;
    }
    .dia-actual::after {
        content: '●';
        position: absolute;
        top: 2px;
        right: 2px;
        color: #0d6efd;
        font-size: 8px;
    }
    
    .codigo-vacio {
        background-color: #fff;
    }
    
    .codigo-input {
        width: 100%;
        border: 1px solid #dee2e6;
        padding: 4px 2px;
        text-align: center;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        background-color: transparent;
        cursor: pointer;
        border-radius: 3px;
        transition: all 0.2s ease;
    }
    
    .codigo-input:hover:not(:disabled) {
        border-color: #0d6efd;
        transform: scale(1.05);
    }
    
    .codigo-input:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    
    .codigo-input:disabled {
        background-color: #e9ecef;
        cursor: not-allowed;
        opacity: 0.6;
    }
    
    .saving {
        background-color: #fff3cd !important;
        animation: pulse 1s infinite;
    }
    
    .saved {
        background-color: #d1e7dd !important;
        animation: fadeIn 0.5s;
    }
    
    .error {
        background-color: #f8d7da !important;
        animation: shake 0.5s;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    
    @keyframes fadeIn {
        from { opacity: 0.5; }
        to { opacity: 1; }
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    .table-container {
        overflow-x: auto;
        max-width: 100%;
        position: relative;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    }
    
    .table-container::-webkit-scrollbar {
        height: 12px;
    }
    
    .table-container::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }
    
    .table-container::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
    }
    
    .table-container::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
    }
    
    .header-dia {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        min-height: 60px;
        padding: 4px 2px;
    }
    
    /* Botón de modo compacto */
    .view-mode-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Modo compacto */
    .compact-mode .roster-table {
        font-size: 0.75rem;
    }
    .compact-mode .codigo-dia {
        min-width: 40px;
        max-width: 40px;
    }
    .compact-mode .col-nombre {
        min-width: 150px;
    }
    
    @media print {
        .no-print {
            display: none;
        }
        .roster-table {
            font-size: 0.7rem;
        }
        .mes-indicator {
            position: static;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Alerta de borradores flotante -->
{% if borradores_count > 0 %}
<div id="borradores-alert" class="alert alert-warning alert-dismissible fade show" role="alert">
    <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Cambios sin Enviar</h5>
    <p class="mb-2">Tienes <strong><span id="contador-borradores">{{ borradores_count }}</span> cambios en borrador</strong> que no han sido enviados para aprobación.</p>
    <hr>
    <form method="post" action="{% url 'enviar_cambios_aprobacion' %}" class="d-inline">
        {% csrf_token %}
        <button type="submit" class="btn btn-warning btn-sm">
            <i class="fas fa-paper-plane"></i> Enviar para Aprobación
        </button>
    </form>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
</div>
{% endif %}

<!-- Indicador de mes sticky -->
<div class="mes-indicator no-print">
    <i class="fas fa-calendar-alt me-2"></i>
    {{ mes_nombre|upper }} {{ anio }}
</div>

<div class="no-print">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-calendar-check"></i> Roster Matricial</h2>
            {% if borradores_count > 0 and not user.is_superuser %}
            {% if not es_responsable %}
            <div class="mt-2">
                <form method="post" action="{% url 'enviar_cambios_aprobacion' %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-paper-plane me-1"></i> 
                        Enviar {{ borradores_count }} Cambio(s) para Aprobación
                    </button>
                </form>
            </div>
            {% endif %}
            {% endif %}
        </div>
        <div>
            <button class="btn btn-outline-secondary me-2" id="toggleCompactMode" title="Alternar modo compacto">
                <i class="fas fa-compress-alt"></i> Modo Compacto
            </button>
            <a href="{% url 'roster_import' %}" class="btn btn-success me-2">
                <i class="fas fa-file-upload"></i> Importar
            </a>
            <a href="{% url 'roster_export' %}?mes={{ mes }}&anio={{ anio }}" class="btn btn-success me-2">
                <i class="fas fa-file-excel"></i> Exportar
            </a>
            <button onclick="window.print()" class="btn btn-secondary me-2">
                <i class="fas fa-print"></i> Imprimir
            </button>
            <a href="{% url 'roster_list' %}" class="btn btn-info">
                <i class="fas fa-list"></i> Vista Lista
            </a>
        </div>
    </div>

    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-2">
                    <label class="form-label">Mes:</label>
                    <select name="mes" class="form-select">
                        {% for m_num, m_nombre in meses %}
                            <option value="{{ m_num }}" {% if m_num == mes %}selected{% endif %}>{{ m_nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Año:</label>
                    <select name="anio" class="form-select">
                        {% for a in anios %}
                            <option value="{{ a }}" {% if a == anio %}selected{% endif %}>{{ a }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">SubÁrea:</label>
                    <select name="subarea" class="form-select">
                        <option value="">Todas las subsubáreas</option>
                        {% for a in areas %}
                            <option value="{{ a.id }}" {% if area_id == a.id|stringformat:"s" %}selected{% endif %}>
                                {{ a.área.nombre }} - {{ a.nombre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Buscar:</label>
                    <input type="text" name="buscar" class="form-control" placeholder="DNI o nombre..." value="{{ buscar }}">
                </div>
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search"></i> Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Control de resultados por página -->
    <div class="card shadow-sm mb-3">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <label class="form-label mb-0">
                        <i class="fas fa-list"></i> Resultados por página:
                    </label>
                </div>
                <div class="col-md-6">
                    <div class="btn-group w-100" role="group">
                        <a href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page=10" 
                           class="btn btn-sm {% if per_page == '10' %}btn-primary{% else %}btn-outline-primary{% endif %}">10</a>
                        <a href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page=20" 
                           class="btn btn-sm {% if per_page == '20' %}btn-primary{% else %}btn-outline-primary{% endif %}">20</a>
                        <a href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page=50" 
                           class="btn btn-sm {% if per_page == '50' %}btn-primary{% else %}btn-outline-primary{% endif %}">50</a>
                        <a href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page=100" 
                           class="btn btn-sm {% if per_page == '100' %}btn-primary{% else %}btn-outline-primary{% endif %}">100</a>
                        <a href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page=todos" 
                           class="btn btn-sm {% if per_page == 'todos' %}btn-primary{% else %}btn-outline-primary{% endif %}">Todos</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-body p-0">
        <div class="alert alert-warning border-warning m-3 no-print" style="border-width: 3px; box-shadow: 0 0 15px rgba(255, 193, 7, 0.5);">
            <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> LEYENDA DE CÓDIGOS - LEER ANTES DE INGRESAR</h5>
            <hr>
            <div class="row">
                <div class="col-md-6">
                    • <strong>T</strong>: Trabajo Presencial<br>
                    • <strong>DL</strong>: Día Libre<br>
                    • <strong>TR</strong>: Trabajo Remoto<br>
                    • <strong>DM</strong>: Descanso Médico<br>
                    • <strong>V</strong>: Vacaciones Aprobadas y/o Gozadas
                </div>
                <div class="col-md-6">
                    • <strong>F</strong>: Feriado No Recuperable<br>
                    • <strong>FC</strong>: Feriado Compensable<br>
                    • <strong>Editable:</strong> Selecciona el código de la lista desplegable. Se guarda automáticamente.<br>
                    • <strong>Cálculo:</strong> Días Libres Pendientes = (Días al 31/12/25 + Ganados) - DL usados<br>
                    • <strong>Nota:</strong> Los cambios deben ser enviados para aprobación
                </div>
            </div>
        </div>

        <div class="table-container">
            <table class="table table-bordered table-sm roster-table mb-0">
                <thead>
                    <tr>
                        <th class="col-nombre">Personal</th>
                        <th class="col-dias-libres" title="Días disponibles al 31/12/25 menos los DLA utilizados">Saldo Días<br>al 31/12/25</th>
                        <th class="col-dias-trabajados">Días Libres<br>Ganados</th>
                        <th class="col-dias-libres">Días Libres<br>Pendientes</th>
                        {% for fecha in fechas_mes %}
                            <th class="codigo-dia">
                                <div class="header-dia">{{ fecha|date:"d" }}</div>
                            </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for fila in tabla_datos %}
                    <tr>
                        <td class="col-nombre">
                            <strong>{{ fila.personal.apellidos_nombres }}</strong><br>
                            <small class="text-muted">{{ fila.personal.nro_doc }} - {{ fila.personal.subarea.nombre|default:"-" }}</small>
                        </td>
                        <td class="col-dias-libres dias-libres-{{ fila.personal.id }}" title="Saldo después de descontar {{ fila.count_dla }} DLA">{{ fila.dias_libres_corte_2025 }}</td>
                        <td class="col-dias-trabajados dias-ganados-{{ fila.personal.id }}" title="T: {{ fila.count_t }}, TR: {{ fila.count_tr }}, DL usados: {{ fila.count_dl }}, DLA usados: {{ fila.count_dla }}">{{ fila.dias_libres_ganados }}</td>
                        <td class="col-dias-libres dias-pendientes-{{ fila.personal.id }}">{{ fila.dias_libres_pendientes|floatformat:0 }}</td>
                        {% for item in fila.codigos %}
                            <td class="codigo-dia 
                                codigo-{{ item.codigo|default:'vacio' }}
                                {% if item.es_sabado %}dia-sabado{% endif %}
                                {% if item.es_domingo %}dia-domingo{% endif %}
                                {% if item.es_hoy %}dia-actual{% endif %}
                            "
                                data-dia-semana="{{ item.fecha|date:'l' }}"
                                {% if item.roster_id %}data-roster-id="{{ item.roster_id }}"{% endif %}
                            >
                                <select 
                                    class="codigo-input" 
                                    data-personal-id="{{ fila.personal.id }}"
                                    data-fecha="{{ item.fecha|date:'Y-m-d' }}"
                                    data-fecha-alta="{{ fila.personal.fecha_alta|date:'Y-m-d'|default:'' }}"
                                    data-dias-corte="{{ fila.dias_libres_corte_2025 }}"
                                    {% if fila.personal.fecha_alta and item.fecha < fila.personal.fecha_alta %}disabled title="Anterior a fecha de alta ({{ fila.personal.fecha_alta|date:'d/m/Y' }})"{% endif %}
                                >
                                    <option value="">-</option>
                                    <option value="T" {% if item.codigo == 'T' %}selected{% endif %}>T</option>
                                    <option value="TR" {% if item.codigo == 'TR' %}selected{% endif %}>TR</option>
                                    <option value="DL" {% if item.codigo == 'DL' %}selected{% endif %}>DL</option>
                                    {% if user.is_superuser %}
                                    <option value="DLA" {% if item.codigo == 'DLA' %}selected{% endif %}>DLA</option>
                                    <option value="DOL" {% if item.codigo == 'DOL' %}selected{% endif %}>DOL</option>
                                    {% endif %}
                                    <option value="DM" {% if item.codigo == 'DM' %}selected{% endif %}>DM</option>
                                    <option value="V" {% if item.codigo == 'V' %}selected{% endif %}>V</option>
                                    <option value="F" {% if item.codigo == 'F' %}selected{% endif %}>F</option>
                                    <option value="FC" {% if item.codigo == 'FC' %}selected{% endif %}>FC</option>
                                </select>
                            </td>
                        {% endfor %}
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="{{ fechas_mes|length|add:3 }}" class="text-center text-muted py-4">
                            No hay personal activo para mostrar
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Paginación -->
        {% if paginator %}
        <div class="card-footer">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="mb-0 text-muted">
                        Mostrando 
                        {% if page_obj.has_other_pages %}
                            {{ page_obj.start_index }} - {{ page_obj.end_index }}
                        {% else %}
                            {% if page_obj|length > 0 %}{{ page_obj|length }}{% else %}0{% endif %}
                        {% endif %}
                        de {{ paginator.count }} trabajadores
                    </p>
                </div>
                <div class="col-md-6">
                    <nav aria-label="Paginación">
                        <ul class="pagination pagination-sm justify-content-end mb-0">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page={{ per_page }}&page=1">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page={{ per_page }}&page={{ page_obj.previous_page_number }}">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-left"></i></span>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">
                                    Página {{ page_obj.number }} de {{ paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page={{ per_page }}&page={{ page_obj.next_page_number }}">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?mes={{ mes }}&anio={{ anio }}&area={{ area_id }}&buscar={{ buscar }}&per_page={{ per_page }}&page={{ paginator.num_pages }}">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-right"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<div class="mt-3 no-print">
    <a href="{% url 'home' %}" class="btn btn-secondary">
        <i class="fas fa-arrow-left"></i> Volver al Inicio
    </a>
    {% if not user.is_superuser and not es_responsable %}
    <button type="button" class="btn btn-warning ms-2" onclick="confirmarEnvioAprobacion()">
        <i class="fas fa-paper-plane me-1"></i> 
        Enviar Cambios para Aprobación
    </button>
    {% endif %}
</div>

<form id="formEnviarAprobacion" method="post" action="{% url 'enviar_cambios_aprobacion' %}" style="display:none;">
    {% csrf_token %}
</form>

<script>
// Diccionario de estados del roster
const rosterEstados = {{ roster_estados|safe }};
let borradoresCount = {{ borradores_count|default:0 }};  // Contador dinámico de borradores

document.addEventListener('DOMContentLoaded', function() {
    const selects = document.querySelectorAll('.codigo-input');
    const tableContainer = document.querySelector('.table-container');
    const toggleBtn = document.getElementById('toggleCompactMode');
    
    // Aplicar estados a las celdas al cargar
    selects.forEach(select => {
        const td = select.parentElement;
        const rosterId = td.dataset.rosterId;
        if (rosterId && rosterEstados[rosterId]) {
            td.classList.add('estado-' + rosterEstados[rosterId]);
        }
    });
    
    // Toggle modo compacto
    if (toggleBtn) {
        toggleBtn.addEventListener('click', function() {
            tableContainer.classList.toggle('compact-mode');
            const icon = this.querySelector('i');
            if (tableContainer.classList.contains('compact-mode')) {
                icon.classList.remove('fa-compress-alt');
                icon.classList.add('fa-expand-alt');
                this.innerHTML = '<i class="fas fa-expand-alt"></i> Modo Normal';
            } else {
                icon.classList.remove('fa-expand-alt');
                icon.classList.add('fa-compress-alt');
                this.innerHTML = '<i class="fas fa-compress-alt"></i> Modo Compacto';
            }
        });
    }
    
    // Obtener CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    
    // Función para actualizar el color de fondo basado en el código
    function updateCellColor(select) {
        const td = select.parentElement;
        const valor = select.value.trim().toUpperCase();
        
        // Remover clases de código anteriores
        td.classList.remove('codigo-T', 'codigo-TR', 'codigo-DL', 'codigo-DLA', 
                           'codigo-DOL', 'codigo-DM', 'codigo-V', 'codigo-F', 'codigo-FC', 'codigo-vacio');
        
        if (valor === '') {
            td.classList.add('codigo-vacio');
        } else {
            td.classList.add('codigo-' + valor);
        }
    }
    
    // Función para guardar el cambio
    function guardarCodigo(select) {
        const personalId = select.dataset.personalId;
        const fecha = select.dataset.fecha;
        const codigo = select.value.trim().toUpperCase();
        const td = select.parentElement;
        
        // Mostrar estado de guardado
        td.classList.add('saving');
        
        // Enviar al servidor
        fetch('{% url "roster_update_cell" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                personal_id: personalId,
                fecha: fecha,
                codigo: codigo
            })
        })
        .then(response => response.json())
        .then(data => {
            td.classList.remove('saving');
            if (data.success) {
                td.classList.add('saved');
                updateCellColor(select);
                
                // Actualizar estado del roster
                if (data.roster_id && data.estado) {
                    td.dataset.rosterId = data.roster_id;
                    const estadoAnterior = rosterEstados[data.roster_id];
                    // Remover clases de estado anteriores
                    td.classList.remove('estado-borrador', 'estado-pendiente', 'estado-aprobado');
                    // Agregar nueva clase de estado
                    td.classList.add('estado-' + data.estado);
                    // Actualizar diccionario local
                    rosterEstados[data.roster_id] = data.estado;
                    // Actualizar título
                    td.title = 'Estado: ' + data.estado.charAt(0).toUpperCase() + data.estado.slice(1);
                    
                    // Actualizar contador de borradores
                    if (data.estado === 'borrador' && estadoAnterior !== 'borrador') {
                        borradoresCount++;
                        actualizarContadorBorradores();
                    } else if (estadoAnterior === 'borrador' && data.estado !== 'borrador') {
                        borradoresCount = Math.max(0, borradoresCount - 1);
                        actualizarContadorBorradores();
                    }
                } else if (!data.roster_id) {
                    // Si se eliminó el roster, verificar si era borrador
                    const rosterId = td.dataset.rosterId;
                    if (rosterId && rosterEstados[rosterId] === 'borrador') {
                        borradoresCount = Math.max(0, borradoresCount - 1);
                        actualizarContadorBorradores();
                        delete rosterEstados[rosterId];
                    }
                }
                
                // Actualizar días libres ganados si viene en la respuesta
                if (data.dias_libres_ganados !== undefined) {
                    const cellDiasGanados = document.querySelector(`.dias-ganados-${personalId}`);
                    if (cellDiasGanados) {
                        cellDiasGanados.textContent = data.dias_libres_ganados;
                    }
                }
                
                // Actualizar días libres pendientes si viene en la respuesta
                if (data.dias_libres_pendientes !== undefined) {
                    const cellDiasPendientes = document.querySelector(`.dias-pendientes-${personalId}`);
                    if (cellDiasPendientes) {
                        cellDiasPendientes.textContent = data.dias_libres_pendientes;
                    }
                }
                
                // Actualizar días al 31/12/25 si viene en la respuesta
                if (data.dias_libres_corte_2025 !== undefined) {
                    const cellDiasCorte = document.querySelector(`.dias-libres-${personalId}`);
                    if (cellDiasCorte) {
                        cellDiasCorte.textContent = data.dias_libres_corte_2025;
                    }
                    // Actualizar el data attribute para futuras validaciones
                    select.dataset.diasCorte = data.dias_libres_corte_2025;
                }
                
                setTimeout(() => {
                    td.classList.remove('saved');
                }, 1000);
            } else {
                td.classList.add('error');
                alert('Error: ' + data.error);
                // Revertir al valor anterior si hubo error
                if (data.revert) {
                    select.value = data.old_value || '';
                    updateCellColor(select);
                }
                setTimeout(() => {
                    td.classList.remove('error');
                }, 2000);
            }
        })
        .catch(error => {
            td.classList.remove('saving');
            td.classList.add('error');
            console.error('Error:', error);
            alert('Error al guardar el código');
            setTimeout(() => {
                td.classList.remove('error');
            }, 2000);
        });
    }
    
    // Event listeners para todos los selects
    selects.forEach(select => {
        // Inicializar color
        updateCellColor(select);
        
        // Al cambiar el valor
        select.addEventListener('change', function() {
            guardarCodigo(this);
        });
    });
});

// Función para actualizar el contador de borradores en la UI
function actualizarContadorBorradores() {
    // Actualizar alerta flotante
    const alertElement = document.getElementById('borradores-alert');
    if (borradoresCount > 0) {
        if (!alertElement) {
            // Crear alerta si no existe
            const newAlert = document.createElement('div');
            newAlert.id = 'borradores-alert';
            newAlert.className = 'alert alert-warning alert-dismissible fade show';
            newAlert.setAttribute('role', 'alert');
            newAlert.innerHTML = `
                <h5 class="alert-heading"><i class="fas fa-exclamation-triangle"></i> Cambios sin Enviar</h5>
                <p class="mb-2">Tienes <strong><span id="contador-borradores">${borradoresCount}</span> cambios en borrador</strong> que no han sido enviados para aprobación.</p>
                <hr>
                <form method="post" action="{% url 'enviar_cambios_aprobacion' %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning btn-sm">
                        <i class="fas fa-paper-plane"></i> Enviar para Aprobación
                    </button>
                </form>
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            `;
            document.querySelector('[class*="mes-indicator"]').insertAdjacentElement('beforebegin', newAlert);
        } else {
            // Actualizar contador existente
            const contadorSpan = alertElement.querySelector('#contador-borradores');
            if (contadorSpan) {
                contadorSpan.textContent = borradoresCount;
            }
        }
    } else if (alertElement) {
        // Ocultar alerta si no hay borradores
        alertElement.remove();
    }
}

// Función para confirmar envío de cambios
function confirmarEnvioAprobacion() {
    if (borradoresCount === 0) {
        alert('No hay cambios pendientes de enviar para aprobación.');
        return;
    }
    
    const mensaje = borradoresCount === 1 
        ? '¿Confirma que desea enviar 1 cambio para aprobación?' 
        : `¿Confirma que desea enviar ${borradoresCount} cambios para aprobación?`;
    
    if (confirm(mensaje)) {
        document.getElementById('formEnviarAprobacion').submit();
    }
}
</script>
{% endblock %}
