{% extends 'base.html' %}

{% block title %}Gestión de Usuarios - Sistema de Gestión Personal{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2"><i class="fas fa-users-cog"></i> Gestión de Usuarios</h1>
    <div>
        <a href="{% url 'usuario_sincronizar' %}" class="btn btn-success me-2">
            <i class="fas fa-sync-alt"></i> Sincronizar Usuarios
        </a>
        <a href="{% url 'home' %}" class="btn btn-secondary">
            <i class="fas fa-home me-1"></i> Inicio
        </a>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Total de usuarios:</strong> {{ total_usuarios }} | 
            <strong>Personal sin vincular:</strong> {{ total_sin_vincular }}
        </div>
    </div>
</div>

<!-- Usuarios Existentes -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <i class="fas fa-list me-2"></i> Usuarios Registrados
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Username</th>
                        <th>Nombre</th>
                        <th>Email</th>
                        <th>Personal Vinculado</th>
                        <th>DNI</th>
                        <th>Admin</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for usuario in usuarios %}
                    <tr>
                        <td>
                            <strong>{{ usuario.username }}</strong>
                        </td>
                        <td>{{ usuario.get_full_name|default:"-" }}</td>
                        <td>{{ usuario.email|default:"-" }}</td>
                        <td>
                            {% if usuario.personal_data %}
                                <span class="badge bg-success">
                                    {{ usuario.personal_data.nombre_completo }}
                                </span>
                            {% else %}
                                <span class="text-muted">Sin vincular</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if usuario.personal_data %}
                                {{ usuario.personal_data.nro_doc }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if usuario.is_superuser %}
                                <span class="badge bg-danger">Admin</span>
                            {% else %}
                                <span class="badge bg-secondary">Usuario</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if not usuario.personal_data %}
                                <button type="button" class="btn btn-sm btn-success" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#vincularModal"
                                        onclick="setUsuarioVincular({{ usuario.id }}, '{{ usuario.username }}')">
                                    <i class="fas fa-link"></i> Vincular
                                </button>
                            {% else %}
                                <form method="post" action="{% url 'usuario_desvincular' usuario.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-warning" 
                                            onclick="return confirm('¿Desvincular usuario de su perfil?')">
                                        <i class="fas fa-unlink"></i> Desvincular
                                    </button>
                                </form>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Personal Sin Usuario -->
{% if total_sin_vincular > 0 %}
<div class="card shadow-sm">
    <div class="card-header bg-warning text-dark">
        <i class="fas fa-user-plus me-2"></i> Personal Sin Usuario Asignado
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>DNI</th>
                        <th>Nombre Completo</th>
                        <th>SubÁrea</th>
                        <th>Cargo</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for persona in personal_sin_usuario %}
                    <tr>
                        <td><strong>{{ persona.nro_doc }}</strong></td>
                        <td>{{ persona.nombre_completo }}</td>
                        <td>
                            {% if persona.area %}
                                {{ persona.subarea.nombre }}
                            {% else %}
                                <span class="text-muted">Sin subárea</span>
                            {% endif %}
                        </td>
                        <td>{{ persona.cargo }}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-primary" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#crearUsuarioModal"
                                    onclick="setPersonalCrear({{ persona.id }}, '{{ persona.nombre_completo }}', '{{ persona.nro_doc }}')">
                                <i class="fas fa-user-plus"></i> Crear Usuario
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal Vincular Usuario Existente -->
<div class="modal fade" id="vincularModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Vincular Usuario con Personal</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'usuario_vincular' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="usuario_id" id="usuario_id_vincular">
                    
                    <div class="mb-3">
                        <label class="form-label">Usuario seleccionado:</label>
                        <input type="text" class="form-control" id="usuario_nombre_vincular" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="personal_id_vincular" class="form-label">Seleccionar Personal:</label>
                        <select name="personal_id" id="personal_id_vincular" class="form-select" required>
                            <option value="">-- Seleccionar --</option>
                            {% for persona in personal_sin_usuario %}
                            <option value="{{ persona.id }}">
                                {{ persona.nro_doc }} - {{ persona.nombre_completo }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Vincular</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Crear Usuario -->
<div class="modal fade" id="crearUsuarioModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Crear Nuevo Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'usuario_crear_y_vincular' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" name="personal_id" id="personal_id_crear">
                    
                    <div class="mb-3">
                        <label class="form-label">Personal seleccionado:</label>
                        <input type="text" class="form-control" id="personal_nombre_crear" readonly>
                    </div>
                    
                    <div class="mb-3">
                        <label for="username_crear" class="form-label">Username: *</label>
                        <input type="text" name="username" id="username_crear" class="form-control" required>
                        <small class="text-muted">Se sugiere usar el DNI como username</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="password_crear" class="form-label">Contraseña: *</label>
                        <input type="password" name="password" id="password_crear" class="form-control" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="email_crear" class="form-label">Email:</label>
                        <input type="email" name="email" id="email_crear" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Crear y Vincular</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function setUsuarioVincular(usuarioId, usuarioNombre) {
    document.getElementById('usuario_id_vincular').value = usuarioId;
    document.getElementById('usuario_nombre_vincular').value = usuarioNombre;
}

function setPersonalCrear(personalId, personalNombre, dni) {
    document.getElementById('personal_id_crear').value = personalId;
    document.getElementById('personal_nombre_crear').value = personalNombre;
    document.getElementById('username_crear').value = dni; // Sugerir DNI como username
}
</script>

{% endblock %}
